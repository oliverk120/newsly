<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Today's M&A Articles</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <nav class="mb-4 space-x-4">
      <a href="/" class="text-blue-600 underline">Home</a>
      <a href="/manage.html" class="text-blue-600 underline">Manage Sources & Filters</a>
      <a href="/enrich.html" class="font-semibold">Today's M&A</a>
    </nav>
    <h1 class="text-2xl font-bold mb-4">Today's M&A Articles</h1>

    <div id="actionResults" class="mb-2 text-sm" style="min-height:1.25rem;"></div>
    <pre id="actionLog" class="mb-4 p-2 text-xs bg-gray-100 whitespace-pre-wrap" style="max-height:200px;overflow:auto;"></pre>

    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Title</th>
          <th class="border px-2 py-1">Enrichments</th>
          <th class="border px-2 py-1">Acquiror</th>
          <th class="border px-2 py-1">Target</th>
          <th class="border px-2 py-1">Text</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script>
      function escapeHtml(str) {
        return str.replace(/[&<>]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[t]));
      }

      function formatBody(text) {
        const limit = 200;
        text = text.replace(/\n+/g, '\n');
        if (text.length <= limit) {
          return `<div class="text-container"><span class="full">${escapeHtml(text)}</span></div>`;
        }
        const preview = escapeHtml(text.slice(0, limit)) + '...';
        return `<div class="text-container"><span class="preview">${preview}</span><span class="full hidden">${escapeHtml(text)}</span> <a href="#" class="seeMore text-blue-600 underline">See more</a></div>`;
      }

      function initToggles() {
        document.querySelectorAll('.seeMore').forEach(link => {
          link.onclick = e => {
            e.preventDefault();
            const container = e.target.closest('.text-container');
            container.querySelector('.preview').classList.toggle('hidden');
            container.querySelector('.full').classList.toggle('hidden');
            e.target.textContent = container.querySelector('.full').classList.contains('hidden') ? 'See more' : 'Hide';
          };
        });
      }

      function initButtons() {
        document.querySelectorAll('.enrichBtn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.getAttribute('data-id');
            const log = document.getElementById('actionLog');
            const results = document.getElementById('actionResults');
            log.textContent = '';
            results.textContent = '';
            console.log('Enriching article', id);

            let data;
            try {
              const resp = await fetch(`/articles/${id}/enrich`, { method: 'POST' });
              data = await resp.json();
            } catch (err) {
              console.error('Enrich request failed', err);
              results.textContent = 'Request failed';
              return;
            }

            console.log('Enrich response', data);
            if (data.body) {
              const wrapper = e.target.closest('tr').querySelector('.article-body');
              wrapper.innerHTML = formatBody(data.body);
              wrapper.classList.remove('hidden');
              e.target.textContent = 'Refresh Text';
              initToggles();
              results.textContent = `Fetched ${data.body.length} characters for article ${id}`;
            } else if (data.error) {
              results.textContent = `Error: ${data.error}`;
            }
            log.textContent = JSON.stringify(data, null, 2);
          });
        });

        document.querySelectorAll('.extractBtn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.getAttribute('data-id');
            const log = document.getElementById('actionLog');
            const results = document.getElementById('actionResults');
            log.textContent = '';
            results.textContent = '';
            console.log('Extracting parties', id);

            let data;
            try {
              const resp = await fetch(`/articles/${id}/extract-parties`, { method: 'POST' });
              data = await resp.json();
            } catch (err) {
              console.error('Extract request failed', err);
              results.textContent = 'Request failed';
              return;
            }

            console.log('Extract response', data);
            if (data.acquiror !== undefined && data.target !== undefined) {
              const row = e.target.closest('tr');
              row.querySelector('.acquiror-cell').textContent = data.acquiror;
              row.querySelector('.target-cell').textContent = data.target;
              results.textContent = `Extracted parties for article ${id}`;
            } else if (data.error) {
              results.textContent = `Error: ${data.error}`;
            }
            log.textContent = JSON.stringify(data, null, 2);
          });
        });
      }

      async function loadArticles() {
        let articles = [];
        try {
          const res = await fetch('/articles/mna-today');
          articles = await res.json();
        } catch (err) {
          console.error('Failed loading articles', err);
          document.getElementById('actionResults').textContent = 'Failed loading articles';
          return;
        }
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        articles.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const btnLabel = a.body ? 'Refresh Text' : 'Get Article Text';
          const bodyHtml = a.body ? formatBody(a.body) : '';
          const hiddenClass = a.body ? '' : 'hidden';
          const disabledCls = 'bg-gray-300 text-gray-600 cursor-not-allowed';
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1"><a class="text-blue-600 underline" href="${a.link}" target="_blank">${a.title}</a></td>` +
            `<td class="border px-2 py-1 space-x-1">` +
              `<button data-id="${a.id}" class="enrichBtn bg-blue-500 text-white px-2 py-1 rounded">${btnLabel}</button>` +
              `<button data-id="${a.id}" class="extractBtn bg-purple-500 text-white px-2 py-1 rounded">Extract Parties</button>` +
              `<button disabled class="${disabledCls} px-2 py-1 rounded">Deal Value</button>` +
              `<button disabled class="${disabledCls} px-2 py-1 rounded">Target Info</button>` +
              `<button disabled class="${disabledCls} px-2 py-1 rounded">Acquirer Info</button>` +
            `</td>` +
            `<td class="border px-2 py-1 acquiror-cell">${a.acquiror || ''}</td>` +
            `<td class="border px-2 py-1 target-cell">${a.target || ''}</td>` +
            `<td class="border px-2 py-1"><div class="article-body ${hiddenClass}">${bodyHtml}</div></td>`;
          tbody.appendChild(tr);
        });
        initButtons();
        initToggles();
      }

      loadArticles();
    </script>
  </body>
</html>
