<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Enriched Articles Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <nav class="mb-4 space-x-4 bg-gray-100 p-2 rounded">
      <a href="/" class="text-blue-600 underline">Home</a>
      <a href="/manage.html" class="text-blue-600 underline">Manage Sources, Filters &amp; Prompts</a>
      <a href="/enrich.html" class="text-blue-600 underline">Enrich Articles</a>
      <a href="/enriched.html" class="font-semibold">Enriched Database</a>
    </nav>
    <h1 class="text-2xl font-bold mb-4">Enriched Articles Database</h1>

    <div class="mb-4 space-x-2">
      <input id="queryInput" class="border px-2 py-1" placeholder="Search text" />
      <input id="thresholdInput" class="border px-2 py-1 w-24" type="number" step="0.01" min="0" max="1" value="0.8" />
      <button id="searchBtn" class="bg-blue-500 text-white px-3 py-1 rounded">Search</button>
    </div>

    <div class="mb-4 space-x-2">
      <input id="filterInput" class="border px-2 py-1" placeholder="Filter keywords" />
    </div>

    <div id="summaryPills" class="mb-4 flex flex-wrap gap-2"></div>

    <table class="table-auto w-full border-collapse mb-4">
      <thead>
        <tr>
          <th class="border px-2 py-1">Title</th>
          <th class="border px-2 py-1">Description</th>
          <th class="border px-2 py-1">Score</th>
          <th class="border px-2 py-1">Link</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>


    <div class="mb-4 space-x-2">
      <label>Completeness:
        <select id="levelSelect" class="border px-2 py-1">
          <option value="all">All</option>
          <option value="full">Fully Complete</option>
          <option value="partial">Incomplete</option>
        </select>
      </label>
      <button id="loadBtn" class="bg-green-500 text-white px-3 py-1 rounded">Load Articles</button>
    </div>

    <div id="stats" class="mb-2 text-sm"></div>

    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Deal</th>
          <th class="border px-2 py-1 w-1/3">Summary</th>
          <th class="border px-2 py-1">Clairfield Sector / Industry</th>
          <th class="border px-2 py-1">Location</th>
          <th class="border px-2 py-1">Completed</th>
          <th class="border px-2 py-1">Text</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script>
      function escapeHtml(str) {
        return str.replace(/[&<>]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[t]));
      }

      function formatBody(text) {
        const limit = 200;
        text = text.replace(/\n+/g, '\n');
        if (text.length <= limit) {
          return `<div class="text-container"><span class="full">${escapeHtml(text)}</span></div>`;
        }
        const preview = escapeHtml(text.slice(0, limit)) + '...';
        return `<div class="text-container"><span class="preview">${preview}</span><span class="full hidden">${escapeHtml(text)}</span> <a href="#" class="seeMore text-blue-600 underline">See more</a></div>`;
      }

      function initToggles() {
        document.querySelectorAll('.seeMore').forEach(link => {
          link.onclick = e => {
            e.preventDefault();
            const container = e.target.closest('.text-container');
            container.querySelector('.preview').classList.toggle('hidden');
            container.querySelector('.full').classList.toggle('hidden');
            e.target.textContent = container.querySelector('.full').classList.contains('hidden') ? 'See more' : 'Hide';
          };
        });
      }

      function formatTombstone(a) {
        const acq = a.acquiror && a.acquiror !== 'N/A' ? escapeHtml(a.acquiror) : '';
        const seller = a.seller && a.seller !== 'N/A' ? escapeHtml(a.seller) : '';
        const target = a.target && a.target !== 'N/A' ? escapeHtml(a.target) : '';
        const lines = [];
        if (acq) lines.push(`<div class="font-bold text-lg">${acq}</div>`);
        if (target) lines.push(`<div class="font-bold text-lg">${target}</div>`);
        if (seller && seller !== target) lines.push(`<div class="font-bold text-lg">${seller}</div>`);
        return lines.join('');
      }

      const sectorIcons = {
        Healthcare: '‚öïÔ∏è',
        Energy: '‚ö°',
        Industrials: 'üè≠',
        Consumer: 'üõí',
        'Financial Services': 'üí∞',
        TMT: 'üíª'
      };

      function formatSectorIndustry(a) {
        if (!a.sector && !a.industry) return '';
        const icon = sectorIcons[a.sector] || 'üè¢';
        const sector = a.sector ? escapeHtml(a.sector) : '';
        const industry = a.industry ? escapeHtml(a.industry) : '';
        return `${icon} ${sector}<br>${industry}`;
      }

      function formatCompleted(str) {
        const types = ['body', 'embedding', 'date', 'location', 'parties', 'summary'];
        const done = str ? str.split(',') : [];
        return types
          .map(t => `<div>${t}: ${done.includes(t) ? '‚úì' : ''}</div>`)
          .join('');
      }

      let allArticles = [];
      const filters = { keyword: '', acquiror: '', seller: '', target: '', location: '', sector: '', industry: '' };

      function renderArticles() {
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        const kw = filters.keyword.toLowerCase();
        const rows = allArticles.filter(a => {
          if (filters.acquiror && a.acquiror !== filters.acquiror) return false;
          if (filters.seller && a.seller !== filters.seller) return false;
          if (filters.target && a.target !== filters.target) return false;
          if (filters.location && a.location !== filters.location) return false;
          if (filters.sector && a.sector !== filters.sector) return false;
          if (filters.industry && a.industry !== filters.industry) return false;
          if (kw) {
            const text = `${a.title} ${a.description || ''} ${a.body || ''}`.toLowerCase();
            if (!text.includes(kw)) return false;
          }
          return true;
        });

        rows.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const bodyHtml = a.body ? formatBody(a.body) : '';
          const hiddenClass = a.body ? '' : 'hidden';
          const tombstone = formatTombstone(a);
          const sectorHtml = formatSectorIndustry(a);
          const completedHtml = formatCompleted(a.completed);
          const truncated = a.title.length > 60 ? a.title.slice(0, 60) + '...' : a.title;
          const titleLink = `<a class="text-blue-600 underline" href="${a.link}" target="_blank">${escapeHtml(truncated)}</a>`;
          const summary = `${escapeHtml(a.summary || '')}<br>${titleLink}`;
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1">${tombstone}</td>` +
            `<td class="border px-2 py-1 w-1/3">${summary}</td>` +
            `<td class="border px-2 py-1">${sectorHtml}</td>` +
            `<td class="border px-2 py-1">${a.location || ''}</td>` +
            `<td class="border px-2 py-1">${completedHtml}</td>` +
            `<td class="border px-2 py-1"><div class="article-body ${hiddenClass}">${bodyHtml}</div></td>`;
          tbody.appendChild(tr);
        });
        initToggles();
      }

      function updateSummary() {
        const container = document.getElementById('summaryPills');
        container.innerHTML = '';
        const groups = {
          acquiror: [...new Set(allArticles.map(a => a.acquiror).filter(Boolean))],
          seller: [...new Set(allArticles.map(a => a.seller).filter(Boolean))],
          target: [...new Set(allArticles.map(a => a.target).filter(Boolean))],
          location: [...new Set(allArticles.map(a => a.location).filter(Boolean))],
          sector: [...new Set(allArticles.map(a => a.sector).filter(Boolean))],
          industry: [...new Set(allArticles.map(a => a.industry).filter(Boolean))]
        };
        Object.entries(groups).forEach(([field, values]) => {
          if (!values.length) return;
          const label = document.createElement('span');
          label.className = 'font-semibold mr-2';
          if (field === 'sector') {
            label.textContent = 'Clairfield Sector:';
          } else {
            label.textContent = field.charAt(0).toUpperCase() + field.slice(1) + ':';
          }
          container.appendChild(label);
          values.slice(0, 10).forEach(v => {
            const pill = document.createElement('span');
            if (field === 'sector') {
              const icon = sectorIcons[v] || 'üè¢';
              pill.innerHTML = `${icon} ${v}`;
            } else {
              pill.textContent = v;
            }
            pill.dataset.field = field;
            pill.dataset.value = v;
            pill.className = 'cursor-pointer bg-gray-200 rounded-full px-2 py-1 text-sm';
            pill.addEventListener('click', () => {
              const cur = filters[field] === v;
              filters[field] = cur ? '' : v;
              container.querySelectorAll(`span[data-field="${field}"]`).forEach(p => {
                p.classList.remove('bg-blue-500', 'text-white');
                p.classList.add('bg-gray-200');
              });
              if (!cur) {
                pill.classList.remove('bg-gray-200');
                pill.classList.add('bg-blue-500', 'text-white');
              }
              renderArticles();
            });
            container.appendChild(pill);
          });
          const spacer = document.createElement('span');
          spacer.className = 'w-full';
          container.appendChild(spacer);
        });
      }

      async function loadArticles() {
        const level = document.getElementById('levelSelect').value;
        const res = await fetch('/articles/enriched-list?level=' + level);
        const data = await res.json();
        allArticles = data.articles;
        document.getElementById('stats').textContent = `Total: ${data.stats.total} | Fully Complete: ${data.stats.full} | Incomplete: ${data.stats.partial}`;
        updateSummary();
        renderArticles();
      }

      function addRow(a, matched) {
        const tr = document.createElement('tr');
        if (matched) tr.classList.add('bg-green-200');
        tr.innerHTML =
          `<td class="border px-2 py-1">${a.title}</td>` +
          `<td class="border px-2 py-1">${a.description || ''}</td>` +
          `<td class="border px-2 py-1">${a.score.toFixed(3)}</td>` +
          `<td class="border px-2 py-1"><a href="${a.link}" target="_blank" class="text-blue-600 underline">Link</a></td>`;
        return tr;
      }

      async function doSearch() {
        const q = document.getElementById('queryInput').value.trim();
        const threshold = parseFloat(document.getElementById('thresholdInput').value) || 0.8;
        if (!q) return;
        const params = new URLSearchParams({ q, threshold });
        const res = await fetch('/articles/semantic-search?' + params.toString());
        const data = await res.json();
        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = '';
        (data.matches || []).forEach(a => tbody.appendChild(addRow(a, true)));
        (data.others || []).forEach(a => tbody.appendChild(addRow(a, false)));
      }

      loadArticles();
      document.getElementById('loadBtn').addEventListener('click', loadArticles);
      document.getElementById('searchBtn').addEventListener('click', doSearch);
      document.getElementById('filterInput').addEventListener('input', e => {
        filters.keyword = e.target.value.trim();
        renderArticles();
      });
    </script>
  </body>
</html>
