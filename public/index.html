<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>News Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <nav class="mb-4 space-x-4 bg-gray-100 p-2 rounded">
      <a href="/" class="font-semibold">Home</a>
      <a href="/manage.html" class="text-blue-600 underline">Manage Sources, Filters & Prompts</a>
      <a href="/enrich.html" class="text-blue-600 underline">Enrich Articles</a>
      <a href="/enriched.html" class="text-blue-600 underline">Enriched Database</a>
    </nav>
    <h1 class="text-2xl font-bold mb-4">News Scraper</h1>

    <div class="mb-4 space-y-2">
      <div class="flex items-center space-x-2">
        <div class="inline-flex rounded-md shadow-sm" role="group">
          <button id="scrapeBtn" class="px-4 py-2 bg-blue-300 hover:bg-blue-400 text-black">Scrape Articles</button>
          <button id="runFiltersBtn" class="px-4 py-2 bg-blue-400 hover:bg-blue-500 text-black">Run Filters</button>
        </div>
      </div>
      <form id="pipelineForm" class="flex flex-wrap items-center space-x-2">
        <label class="mr-2"><input type="checkbox" name="steps" value="body" checked> Body</label>
        <label class="mr-2"><input type="checkbox" name="steps" value="date" checked> Date</label>
        <label class="mr-2"><input type="checkbox" name="steps" value="parties" checked> Parties</label>
        <label class="mr-2"><input type="checkbox" name="steps" value="summary" checked> Summary</label>
        <label class="mr-2"><input type="checkbox" name="steps" value="value" checked> Value</label>
        <label class="mr-2">Since <input type="date" name="since" class="border rounded px-1 ml-1" /></label>
        <label class="mr-2"><input type="checkbox" name="incomplete" value="1"> Incomplete only</label>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Run Pipeline</button>
      </form>
      <button id="runMissingBtn" type="button" class="bg-green-500 text-white px-4 py-2 rounded">Run Missing Steps</button>
    </div>
    <p class="text-sm text-gray-600 mb-2">Scrapes new articles, runs filters and enriches the matches.</p>

    <div id="scrapeResults" class="mb-2 text-sm"></div>
    <div id="lastScrape" class="mb-2 text-sm"></div>
    <pre id="scrapeLog" class="mb-4 p-2 text-xs bg-gray-100 whitespace-pre-wrap"></pre>

    <div class="flex items-center mb-2 space-x-2">
      <h2 class="text-xl font-semibold">Sources</h2>
    </div>
    <table class="table-auto w-full mb-6 border-collapse" id="sourcesTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Base URL</th>
        </tr>
      </thead>
      <tbody id="sourcesBody"></tbody>
    </table>

    <div class="flex items-center mb-2 space-x-2">
      <h2 class="text-xl font-semibold">Active Filters</h2>
    </div>
    <p class="text-sm text-gray-600 mb-2">Use <code>*</code> for any number of characters and <code>?</code> for a single character in keyword filters.</p>
    <table class="table-auto w-full mb-6 border-collapse" id="filtersTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">Type</th>
          <th class="border px-2 py-1">Value</th>
        </tr>
      </thead>
      <tbody id="filtersBody"></tbody>
    </table>

    <h2 class="text-xl font-semibold mb-2">Articles</h2>
    <div id="stats" class="mb-2"></div>
    <div id="enrichStats" class="mb-2"></div>
    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Title</th>
          <th class="border px-2 py-1">Description</th>
          <th class="border px-2 py-1">Time</th>
          <th class="border px-2 py-1">Link</th>
          <th class="border px-2 py-1">Match</th>
          <th class="border px-2 py-1">Body</th>
          <th class="border px-2 py-1">Embed</th>
          <th class="border px-2 py-1">Date</th>
          <th class="border px-2 py-1">Location</th>
          <th class="border px-2 py-1">Parties</th>
          <th class="border px-2 py-1">Summary</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script>
      async function loadSources() {
        const res = await fetch('/sources');
        const sources = await res.json();
        const tbody = document.getElementById('sourcesBody');
        tbody.innerHTML = '';
        sources.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="border px-2 py-1">${s.base_url}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadFilters() {
        const res = await fetch('/filters');
        const filters = (await res.json()).filter(f => f.active);
        const tbody = document.getElementById('filtersBody');
        tbody.innerHTML = '';
        filters.forEach(f => {
          const tr = document.createElement('tr');
          const cls = colorClasses[f.id % colorClasses.length];
          tr.innerHTML =
            `<td class="border px-2 py-1 ${cls}">${f.name || ''}</td>` +
            `<td class="border px-2 py-1 ${cls}">${f.type}</td>` +
            `<td class="border px-2 py-1 ${cls}">${f.value || ''}</td>`;
          tbody.appendChild(tr);
        });
      }

      const colorClasses = [
        'bg-red-200 text-red-800',
        'bg-green-200 text-green-800',
        'bg-blue-200 text-blue-800',
        'bg-yellow-200 text-yellow-800',
        'bg-purple-200 text-purple-800',
        'bg-pink-200 text-pink-800',
        'bg-orange-200 text-orange-800'
      ];

      const enrichSteps = ['body', 'embedding', 'date', 'location', 'parties', 'summary'];

      async function loadArticles() {
        const res = await fetch('/articles/enriched-list?level=all');
        const data = await res.json();
        const articles = data.articles;
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        articles.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const pills = (a.filter_names || []).map((name, i) => {
            const cls = colorClasses[a.filter_ids[i] % colorClasses.length];
            return `<span class="px-2 py-1 mr-1 rounded text-xs ${cls}">${name}</span>`;
          }).join('');
          const done = a.completed ? a.completed.split(',') : [];
          const stepCells = enrichSteps.map(s => {
            const ok = done.includes(s);
            const cls = ok ? '' : 'bg-red-200';
            return `<td class="border px-2 py-1 text-center ${cls}">${ok ? 'âœ“' : ''}</td>`;
          }).join('');
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1">${a.title}</td>` +
            `<td class="border px-2 py-1">${a.description}</td>` +
            `<td class="border px-2 py-1">${a.time}</td>` +
            `<td class="border px-2 py-1"><a class="text-blue-600 underline" href="${a.link}" target="_blank">Link</a></td>` +
            `<td class="border px-2 py-1 text-center">${pills}</td>` +
            stepCells;
          tbody.appendChild(tr);
        });
        document.getElementById('enrichStats').textContent =
          `Total: ${data.stats.total} | Fully Complete: ${data.stats.full} | Incomplete: ${data.stats.partial}`;
      }

      async function loadStats() {
        const res = await fetch('/stats');
        const data = await res.json();
        const div = document.getElementById('stats');
        const last = document.getElementById('lastScrape');
        let sourceParts = '';
        for (const [src, count] of Object.entries(data.bySource)) {
          sourceParts += `${src}: ${count} articles `;
        }
        div.textContent = `Total: ${data.total} | Latest: ${data.latest || 'N/A'} | Earliest: ${data.earliest || 'N/A'} | ${sourceParts}`;
        if (last) last.textContent = `Last scrape: ${data.latest || 'N/A'}`;
      }

      const scrapeBtn = document.getElementById('scrapeBtn');
      const runFiltersBtn = document.getElementById('runFiltersBtn');
      const pipelineForm = document.getElementById('pipelineForm');
      const runMissingBtn = document.getElementById('runMissingBtn');

      scrapeBtn.addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Scraping started...';

        const res = await fetch('/scrape');
        const data = await res.json();
        div.innerHTML = data.details
          .map(d => `${d.base_url}: scraped ${d.scraped}, added ${d.inserted}`)
          .join('<br>');
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
        loadStats();
      });

      runFiltersBtn.addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Running filters...';

        const res = await fetch('/run-filters');
        const data = await res.json();
        div.textContent = `Processed ${data.processed} articles`;
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
      });

      runMissingBtn.addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Running pipeline...';

        const formData = new FormData(pipelineForm);
        const steps = formData.getAll('steps');
        const since = formData.get('since');

        const params = new URLSearchParams();
        if (steps.length) params.set('steps', steps.join(','));
        if (since) params.set('since', since);
        params.set('incomplete', '1');

        const res = await fetch(`/pipeline/run?${params.toString()}`);
        const data = await res.json();
        if (!res.ok || data.error) {
          div.textContent = 'Error running pipeline';
        } else {
          div.textContent = `Processed ${data.processed} articles`;
        }
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
        loadStats();
      });

      pipelineForm.addEventListener('submit', async e => {
        e.preventDefault();
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Running pipeline...';

        const formData = new FormData(pipelineForm);
        const steps = formData.getAll('steps');
        const since = formData.get('since');
        const incomplete = formData.get('incomplete');

        const params = new URLSearchParams();
        if (steps.length) params.set('steps', steps.join(','));
        if (since) params.set('since', since);
        if (incomplete) params.set('incomplete', '1');

        const res = await fetch(`/pipeline/run?${params.toString()}`);
        const data = await res.json();
        if (!res.ok || data.error) {
          div.textContent = 'Error running pipeline';
        } else {
          div.textContent = `Processed ${data.processed} articles`;
        }
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
        loadStats();
      });

      loadSources();
      loadArticles();
      loadStats();
      loadFilters();
    </script>
  </body>
</html>
