<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>News Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <nav class="mb-4 space-x-4">
      <a href="/" class="font-semibold">Home</a>
      <a href="/manage.html" class="text-blue-600 underline">Manage Sources & Filters</a>
    </nav>
    <h1 class="text-2xl font-bold mb-4">News Scraper</h1>

    <button id="scrapeBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">Scrape Articles</button>
    <div id="scrapeResults" class="mb-2 text-sm"></div>
    <pre id="scrapeLog" class="mb-4 p-2 text-xs bg-gray-100 whitespace-pre-wrap"></pre>

    <div id="stats" class="mb-2"></div>

    <h2 class="text-xl font-semibold mb-2">Sources</h2>
    <table class="table-auto w-full mb-6 border-collapse" id="sourcesTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Base URL</th>
        </tr>
      </thead>
      <tbody id="sourcesBody"></tbody>
    </table>

    <h2 class="text-xl font-semibold mb-2">Active Filters</h2>
    <table class="table-auto w-full mb-6 border-collapse" id="filtersTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">Type</th>
          <th class="border px-2 py-1">Value</th>
        </tr>
      </thead>
      <tbody id="filtersBody"></tbody>
    </table>

    <h2 class="text-xl font-semibold mb-2">Articles</h2>
    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Title</th>
          <th class="border px-2 py-1">Description</th>
          <th class="border px-2 py-1">Time</th>
          <th class="border px-2 py-1">Link</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script>
      async function loadSources() {
        const res = await fetch('/sources');
        const sources = await res.json();
        const tbody = document.getElementById('sourcesBody');
        tbody.innerHTML = '';
        sources.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="border px-2 py-1">${s.base_url}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadFilters() {
        const res = await fetch('/filters');
        const filters = (await res.json()).filter(f => f.active);
        const tbody = document.getElementById('filtersBody');
        tbody.innerHTML = '';
        filters.forEach(f => {
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td class="border px-2 py-1">${f.name || ''}</td>` +
            `<td class="border px-2 py-1">${f.type}</td>` +
            `<td class="border px-2 py-1">${f.value || ''}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadArticles() {
        const res = await fetch('/articles');
        const articles = await res.json();
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        articles.forEach((a, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1">${a.title}</td>` +
            `<td class="border px-2 py-1">${a.description}</td>` +
            `<td class="border px-2 py-1">${a.time}</td>` +
            `<td class="border px-2 py-1"><a class="text-blue-600 underline" href="${a.link}" target="_blank">Link</a></td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadStats() {
        const res = await fetch('/stats');
        const data = await res.json();
        const div = document.getElementById('stats');
        let sourceParts = '';
        for (const [src, count] of Object.entries(data.bySource)) {
          sourceParts += `${src}: ${count} articles `;
        }
        div.textContent = `Total: ${data.total} | Latest: ${data.latest || 'N/A'} | ${sourceParts}`;
      }

      document.getElementById('scrapeBtn').addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = '';

        const res = await fetch('/scrape');
        const data = await res.json();
        div.innerHTML = data.details
          .map(d => `${d.base_url}: scraped ${d.scraped}, added ${d.inserted}`)
          .join('<br>');
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
        loadStats();
      });

      loadSources();
      loadArticles();
      loadStats();
      loadFilters();
    </script>
  </body>
</html>
