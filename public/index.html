<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>News Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <nav class="mb-4 space-x-4 bg-gray-100 p-2 rounded">
      <a href="/" class="font-semibold">Home</a>
      <a href="/manage.html" class="text-blue-600 underline">Manage Sources, Filters & Prompts</a>
      <a href="/enrich.html" class="text-blue-600 underline">Enrich Articles</a>
      <a href="/enriched.html" class="text-blue-600 underline">Enriched Database</a>
    </nav>
    <h1 class="text-2xl font-bold mb-4">News Scraper</h1>

    <div class="mb-4 flex items-center space-x-2">
      <div class="inline-flex rounded-md shadow-sm" role="group">
        <button id="scrapeBtn" class="px-4 py-2 bg-blue-300 hover:bg-blue-400 text-black">Scrape Articles</button>
        <button id="runFiltersBtn" class="px-4 py-2 bg-blue-400 hover:bg-blue-500 text-black">Run Filters</button>
      </div>
      <button id="fullRunBtn" class="bg-green-600 text-white px-4 py-2 rounded">Run Full Pipeline</button>
      <button id="stopBtn" class="bg-red-600 text-white px-4 py-2 rounded hidden">Stop</button>
    </div>
    <p class="text-sm text-gray-600 mb-2">Scrapes new articles, runs filters and enriches the matches.</p>

    <div id="scrapeResults" class="mb-2 text-sm"></div>
    <pre id="scrapeLog" class="mb-4 p-2 text-xs bg-gray-100 whitespace-pre-wrap"></pre>

    <div class="flex items-center mb-2 space-x-2">
      <h2 class="text-xl font-semibold">Sources</h2>
    </div>
    <table class="table-auto w-full mb-6 border-collapse" id="sourcesTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Base URL</th>
        </tr>
      </thead>
      <tbody id="sourcesBody"></tbody>
    </table>

    <div class="flex items-center mb-2 space-x-2">
      <h2 class="text-xl font-semibold">Active Filters</h2>
    </div>
    <p class="text-sm text-gray-600 mb-2">Use <code>*</code> for any number of characters and <code>?</code> for a single character in keyword filters.</p>
    <table class="table-auto w-full mb-6 border-collapse" id="filtersTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">Name</th>
          <th class="border px-2 py-1">Type</th>
          <th class="border px-2 py-1">Value</th>
        </tr>
      </thead>
      <tbody id="filtersBody"></tbody>
    </table>

    <h2 class="text-xl font-semibold mb-2">Articles</h2>
    <div id="stats" class="mb-2"></div>
    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Title</th>
          <th class="border px-2 py-1">Description</th>
          <th class="border px-2 py-1">Time</th>
          <th class="border px-2 py-1">Link</th>
          <th class="border px-2 py-1">Match</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script>
      async function loadSources() {
        const res = await fetch('/sources');
        const sources = await res.json();
        const tbody = document.getElementById('sourcesBody');
        tbody.innerHTML = '';
        sources.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="border px-2 py-1">${s.base_url}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadFilters() {
        const res = await fetch('/filters');
        const filters = (await res.json()).filter(f => f.active);
        const tbody = document.getElementById('filtersBody');
        tbody.innerHTML = '';
        filters.forEach(f => {
          const tr = document.createElement('tr');
          const cls = colorClasses[f.id % colorClasses.length];
          tr.innerHTML =
            `<td class="border px-2 py-1 ${cls}">${f.name || ''}</td>` +
            `<td class="border px-2 py-1 ${cls}">${f.type}</td>` +
            `<td class="border px-2 py-1 ${cls}">${f.value || ''}</td>`;
          tbody.appendChild(tr);
        });
      }

      const colorClasses = [
        'bg-red-200 text-red-800',
        'bg-green-200 text-green-800',
        'bg-blue-200 text-blue-800',
        'bg-yellow-200 text-yellow-800',
        'bg-purple-200 text-purple-800',
        'bg-pink-200 text-pink-800',
        'bg-orange-200 text-orange-800'
      ];

      async function loadArticles() {
        const res = await fetch('/articles');
        const articles = await res.json();
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        articles.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const pills = (a.filter_names || []).map((name, i) => {
            const cls = colorClasses[a.filter_ids[i] % colorClasses.length];
            return `<span class="px-2 py-1 mr-1 rounded text-xs ${cls}">${name}</span>`;
          }).join('');
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1">${a.title}</td>` +
            `<td class="border px-2 py-1">${a.description}</td>` +
            `<td class="border px-2 py-1">${a.time}</td>` +
            `<td class="border px-2 py-1"><a class="text-blue-600 underline" href="${a.link}" target="_blank">Link</a></td>` +
            `<td class="border px-2 py-1 text-center">${pills}</td>`;
          tbody.appendChild(tr);
        });
      }

      async function loadStats() {
        const res = await fetch('/stats');
        const data = await res.json();
        const div = document.getElementById('stats');
        let sourceParts = '';
        for (const [src, count] of Object.entries(data.bySource)) {
          sourceParts += `${src}: ${count} articles `;
        }
        div.textContent = `Total: ${data.total} | Latest: ${data.latest || 'N/A'} | Earliest: ${data.earliest || 'N/A'} | ${sourceParts}`;
      }

      const scrapeBtn = document.getElementById('scrapeBtn');
      const runFiltersBtn = document.getElementById('runFiltersBtn');
      const fullRunBtn = document.getElementById('fullRunBtn');
      const stopBtn = document.getElementById('stopBtn');

      let es;
      let totalEnrich = 0;
      let progress = 0;

      const updateBar = () => {
        if (!totalEnrich) return;
        const bar = Array.from({ length: totalEnrich }, (_, i) => i < progress ? 'â–ˆ' : '_').join('');
        document.getElementById('scrapeLog').textContent = 'Enriching ' + bar;
      };

      scrapeBtn.addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Scraping started...';

        const res = await fetch('/scrape');
        const data = await res.json();
        div.innerHTML = data.details
          .map(d => `${d.base_url}: scraped ${d.scraped}, added ${d.inserted}`)
          .join('<br>');
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
        loadStats();
      });

      runFiltersBtn.addEventListener('click', async () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Running filters...';

        const res = await fetch('/run-filters');
        const data = await res.json();
        div.textContent = `Processed ${data.processed} articles`;
        log.textContent = (data.logs || []).join('\n');
        loadArticles();
      });

      fullRunBtn.addEventListener('click', () => {
        const log = document.getElementById('scrapeLog');
        const div = document.getElementById('scrapeResults');
        log.textContent = '';
        div.textContent = 'Running full pipeline...';
        totalEnrich = 0;
        progress = 0;
        es = new EventSource('/scrape-enrich-stream');
        stopBtn.classList.remove('hidden');
        es.onmessage = e => {
          if (e.data.startsWith('Enriching ') && e.data.endsWith(' articles')) {
            const m = e.data.match(/Enriching (\d+) articles/);
            if (m) {
              totalEnrich = parseInt(m[1], 10);
              progress = 0;
              updateBar();
              return;
            }
          }
          const m = e.data.match(/^Enriched (\d+)/(\d+)/);
          if (m) {
            progress = parseInt(m[1], 10);
            updateBar();
            return;
          }
          log.textContent += e.data + '\n';
          log.scrollTop = log.scrollHeight;
        };
        es.addEventListener('done', e => {
          es.close();
          stopBtn.classList.add('hidden');
          try {
            const data = JSON.parse(e.data);
            if (!data.error) {
              div.textContent = `Inserted ${data.inserted} new, enriched ${data.enriched}`;
            } else {
              div.textContent = 'Error: ' + data.error;
            }
          } catch {
            div.textContent = 'Completed';
          }
          loadArticles();
          loadStats();
        });
        es.onerror = () => {
          es.close();
          stopBtn.classList.add('hidden');
        };
      });

      stopBtn.addEventListener('click', async () => {
        if (es) es.close();
        stopBtn.classList.add('hidden');
        await fetch('/stop-pipeline', { method: 'POST' });
      });

      loadSources();
      loadArticles();
      loadStats();
      loadFilters();
    </script>
  </body>
</html>
