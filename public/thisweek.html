<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>This Week in M&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="p-4">
    <h1 class="text-2xl font-bold mb-4">This Week in M&A</h1>

    <div id="summaryPills" class="mb-4 flex flex-wrap gap-2"></div>
    <div id="datePills" class="mb-4 flex flex-wrap gap-2">
      <span data-range="week" class="date-pill cursor-pointer rounded-full px-2 py-1 text-sm bg-blue-500 text-white">This Week</span>
      <span data-range="month" class="date-pill cursor-pointer rounded-full px-2 py-1 text-sm bg-gray-200">This Month</span>
      <span data-range="year" class="cursor-not-allowed rounded-full px-2 py-1 text-sm bg-gray-300 text-gray-500">This Year</span>
    </div>

    <div id="stats" class="mb-2 text-sm"></div>

    <table class="table-auto w-full border-collapse">
      <thead>
        <tr>
          <th class="border px-2 py-1">#</th>
          <th class="border px-2 py-1">Deal</th>
          <th class="border px-2 py-1 w-1/3">Summary</th>
          <th class="border px-2 py-1">Clairfield Sector / Industry</th>
          <th class="border px-2 py-1">Location</th>
          <th class="border px-2 py-1">Deal Size</th>
        </tr>
      </thead>
      <tbody id="articlesBody"></tbody>
    </table>
    <script type="module">
      import { createTombstone, escapeHtml } from './tombstone.js';
      import { sectorIcons } from './sectorIcons.js';

      function initDatePills() {
        document.querySelectorAll('.date-pill').forEach(pill => {
          pill.addEventListener('click', () => {
            if (pill.classList.contains('cursor-not-allowed')) return;
            filters.dateRange = pill.dataset.range;
            updateDatePills();
            renderArticles();
          });
        });
      }

      function updateDatePills() {
        document.querySelectorAll('.date-pill').forEach(pill => {
          if (pill.dataset.range === filters.dateRange) {
            pill.classList.remove('bg-gray-200');
            pill.classList.add('bg-blue-500','text-white');
          } else if (!pill.classList.contains('cursor-not-allowed')) {
            pill.classList.remove('bg-blue-500','text-white');
            pill.classList.add('bg-gray-200');
          }
        });
      }

      let allArticles = [];
      const filters = { sector: '', industry: '', dealValue: '', dateRange: 'week' };

      function parseDealValueMillions(str) {
        if (!str) return null;
        const lower = str.toLowerCase();
        if (lower.includes('undisclosed')) return null;
        const m = str.replace(/[, ]/g, '').match(/(\d+(?:\.\d+)?)/);
        if (!m) return null;
        let num = parseFloat(m[1]);
        if (/b|bn|billion/i.test(lower)) num *= 1000;
        return num;
      }

      function valueBucket(str) {
        const val = parseDealValueMillions(str);
        if (val == null) return 'Undisclosed';
        if (val < 20) return '0-20M';
        if (val < 100) return '20-100M';
        if (val < 1000) return '100M-1B';
        return '1B+';
      }

      function formatSectorIndustry(a) {
        if (!a.sector && !a.industry) return '';
        const icon = sectorIcons[a.sector] || 'ðŸ¢';
        const sector = a.sector ? escapeHtml(a.sector) : '';
        const industry = a.industry ? escapeHtml(a.industry) : '';
        return `${icon} ${sector}<br>${industry}`;
      }

      function getRows(ignore) {
        return allArticles.filter(a => {
          if (ignore !== 'sector' && filters.sector && a.sector !== filters.sector) return false;
          if (ignore !== 'industry' && filters.industry && a.industry !== filters.industry) return false;
          if (ignore !== 'dealValue' && filters.dealValue && a.valueBucket !== filters.dealValue) return false;
          if (filters.dateRange) {
            const d = new Date(a.article_date);
            if (isFinite(d)) {
              const now = new Date();
              let start, end;
              if (filters.dateRange === 'week') {
                const day = now.getDay();
                const diff = (day === 0 ? -6 : 1) - day;
                start = new Date(now);
                start.setHours(0,0,0,0);
                start.setDate(start.getDate() + diff);
                end = new Date(start);
                end.setDate(start.getDate() + 7);
              } else if (filters.dateRange === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth()+1, 1);
              } else if (filters.dateRange === 'year') {
                start = new Date(now.getFullYear(), 0, 1);
                end = new Date(now.getFullYear()+1, 0, 1);
              }
              if (start && end && (d < start || d >= end)) return false;
            }
          }
          return true;
        });
      }

      function renderArticles() {
        const tbody = document.getElementById('articlesBody');
        tbody.innerHTML = '';
        const rows = getRows();
        rows.forEach((a, idx) => {
          const tr = document.createElement('tr');
          const tombstone = createTombstone(a);
          const sectorHtml = formatSectorIndustry(a);
          const truncated = a.title.length > 60 ? a.title.slice(0, 60) + '...' : a.title;
          const titleLink = `<a class="text-blue-600 underline" href="${a.link}" target="_blank">${escapeHtml(truncated)}</a>`;
          const summary = `${escapeHtml(a.summary || '')}<br>${titleLink}`;
          tr.innerHTML =
            `<td class="border px-2 py-1">${idx + 1}</td>` +
            `<td class="border px-2 py-1">${tombstone}</td>` +
            `<td class="border px-2 py-1 w-1/3">${summary}</td>` +
            `<td class="border px-2 py-1">${sectorHtml}</td>` +
            `<td class="border px-2 py-1">${a.location || ''}</td>` +
            `<td class="border px-2 py-1">${a.deal_value || ''}</td>`;
          tbody.appendChild(tr);
        });
      }

      function updateSummary() {
        const container = document.getElementById('summaryPills');
        container.innerHTML = '';

        const sectorCounts = {};
        allArticles.forEach(a => {
          if (a.sector) sectorCounts[a.sector] = (sectorCounts[a.sector] || 0) + 1;
        });

        const industryCounts = {};
        getRows('industry').forEach(a => {
          if (a.industry) industryCounts[a.industry] = (industryCounts[a.industry] || 0) + 1;
        });

        const valueCounts = {};
        getRows('dealValue').forEach(a => {
          const b = a.valueBucket;
          valueCounts[b] = (valueCounts[b] || 0) + 1;
        });

        const groups = {
          sector: Object.keys(sectorCounts),
          industry: Object.keys(industryCounts),
          dealValue: ['0-20M','20-100M','100M-1B','1B+','Undisclosed'].filter(b => valueCounts[b])
        };
        Object.entries(groups).forEach(([field, values]) => {
          if (!values.length) return;
          const label = document.createElement('span');
          label.className = 'font-semibold mr-2';
          if (field === 'sector') {
            label.textContent = 'Clairfield Sector:';
          } else {
            label.textContent = field === 'dealValue' ? 'Deal Value:' : 'Industry:';
          }
          container.appendChild(label);
          values.slice(0, 10).forEach(v => {
            const pill = document.createElement('span');
            if (field === 'sector') {
              const icon = sectorIcons[v] || 'ðŸ¢';
              const count = sectorCounts[v] || 0;
              pill.innerHTML = `${icon} ${v} (${count})`;
            } else if (field === 'industry') {
              const count = industryCounts[v] || 0;
              pill.textContent = `${v} (${count})`;
            } else {
              const count = valueCounts[v] || 0;
              pill.textContent = `${v} (${count})`;
            }
            pill.dataset.field = field;
            pill.dataset.value = v;
            pill.className = 'cursor-pointer rounded-full px-2 py-1 text-sm';
            if (filters[field] === v) {
              pill.classList.add('bg-blue-500', 'text-white');
            } else {
              pill.classList.add('bg-gray-200');
            }
            pill.addEventListener('click', () => {
              const cur = filters[field] === v;
              filters[field] = cur ? '' : v;
              updateSummary();
              renderArticles();
            });
            container.appendChild(pill);
          });
          const spacer = document.createElement('span');
          spacer.className = 'w-full';
          container.appendChild(spacer);
        });
      }

      async function loadArticles() {
        const res = await fetch('/articles/enriched-list?level=full');
        const data = await res.json();
        allArticles = data.articles.map(a => ({ ...a, valueBucket: valueBucket(a.deal_value) }));
        document.getElementById('stats').textContent = `Total: ${data.stats.total} | Fully Complete: ${data.stats.full} | Incomplete: ${data.stats.partial}`;
        updateSummary();
        renderArticles();
      }

      loadArticles();
      initDatePills();
    </script>
  </body>
</html>
